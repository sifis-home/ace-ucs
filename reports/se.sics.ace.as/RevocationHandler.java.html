<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RevocationHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ACE library</a> &gt; <a href="index.source.html" class="el_package">se.sics.ace.as</a> &gt; <span class="el_source">RevocationHandler.java</span></div><h1>RevocationHandler.java</h1><pre class="source lang-java linenums">package se.sics.ace.as;

import com.upokecenter.cbor.CBORObject;
import org.eclipse.californium.core.observe.ObserveRelationFilter;
import se.sics.ace.AceException;
import se.sics.ace.Constants;
import se.sics.ace.TimeProvider;
import se.sics.ace.as.logging.DhtLogger;
import se.sics.ace.as.logging.Const;
import se.sics.ace.coap.as.AceObservableEndpoint;
import se.sics.ace.ucs.UcsHelper;

import java.util.*;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author Marco Rasori
 *
 */
public class RevocationHandler {

    /**
     * The logger
     */
<span class="fc" id="L27">    private static final Logger LOGGER</span>
<span class="fc" id="L28">            = Logger.getLogger(RevocationHandler.class.getName());</span>

    /**
     * The database connector for storing and retrieving stuff.
     */
    private DBConnector db;

<span class="fc" id="L35">    private AceObservableEndpoint trl = null;</span>

    private TimeProvider time;

<span class="fc" id="L39">    private Map&lt;String, String&gt; peerIdentitiesToNames = null;</span>

<span class="fc" id="L41">    private PDP pdp = null;</span>

    private Map&lt;String, DiffSet&gt; DiffSetsMap;

    public RevocationHandler(DBConnector db,
                             PDP pdp,
                             TimeProvider time,
                             Map&lt;String, String&gt; peerIdentitiesToNames,
                             Map&lt;String, DiffSet&gt; DiffSetsMap,
                             AceObservableEndpoint trl)
<span class="fc" id="L51">                                throws AceException {</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">        if (db == null) {</span>
<span class="nc" id="L53">            LOGGER.severe(&quot;RevocationHandler's DBConnector was null&quot;);</span>
<span class="nc" id="L54">            throw new AceException(</span>
                    &quot;RevocationHandler's DBConnector must be non-null&quot;);
        }
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (time == null) {</span>
<span class="nc" id="L58">            LOGGER.severe(&quot;RevocationHandler's TimeProvider was null&quot;);</span>
<span class="nc" id="L59">            throw new AceException(&quot;RevocationHandler's TimeProvider &quot;</span>
                    + &quot;must be non-null&quot;);
        }

<span class="fc" id="L63">        this.pdp = pdp;</span>
<span class="fc" id="L64">        this.db = db;</span>
<span class="fc" id="L65">        this.time = time;</span>
<span class="fc" id="L66">        this.peerIdentitiesToNames = peerIdentitiesToNames;</span>
<span class="fc" id="L67">        this.DiffSetsMap = DiffSetsMap;</span>
<span class="fc" id="L68">        this.trl = trl;</span>
<span class="fc" id="L69">    }</span>

    public void revoke(String cti) throws AceException {

        // Get token expiration time (exp)
        long delay;
        try {
<span class="nc" id="L76">            delay = getTimeToExpire(cti);</span>
<span class="nc" id="L77">        } catch (AceException e) {</span>
<span class="nc" id="L78">            LOGGER.log(Level.INFO, &quot;Revocation aborted: (getting token expiration time)&quot;);</span>
<span class="nc" id="L79">            DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                    &quot;Revocation aborted: (getting token expiration time)&quot;);
<span class="nc" id="L81">            throw e;</span>
<span class="nc" id="L82">        }</span>

        // The token to be revoked was already expired
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (delay &lt; 0){</span>
<span class="nc" id="L86">            LOGGER.log(Level.INFO, &quot;The token to revoke was already expired&quot;);</span>
<span class="nc" id="L87">            DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                    &quot;Revocation aborted: The token to revoke was already expired&quot;);
<span class="nc" id="L89">            return;</span>
        }


        // Put the token in the trlTable
<span class="nc" id="L94">        db.addRevokedToken(cti);</span>

        // Put the token hash in each DiffSet of the pertaining peers
<span class="nc" id="L97">        Set&lt;String&gt; peerIds = db.getPertainingPeers(cti);</span>
        try {
<span class="nc" id="L99">            addRevokedTokenHashToDiffSets(cti, peerIds);</span>
<span class="nc" id="L100">        } catch (AceException e) {</span>
<span class="nc" id="L101">            LOGGER.log(Level.INFO, &quot;Revocation aborted: (adding diff entry)&quot;);</span>
<span class="nc" id="L102">            DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                    &quot;Revocation aborted: (adding diff entry)&quot;);
<span class="nc" id="L104">            throw e;</span>
<span class="nc" id="L105">        }</span>

        // Schedule a task to run at time exp-now, that:
        //   - if /trl is present, calls the changed(filter) to notify peers
        //   - removes the token from trlTable
<span class="nc" id="L110">        Timer timer = new Timer();</span>
<span class="nc" id="L111">        timer.schedule(new ExpirationTask(cti), delay);</span>

        // Notify observing pertaining peers
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (trl != null) {</span>
<span class="nc" id="L115">            ObserveRelationFilter filter = new PertainingPeersFilter(peerIds, peerIdentitiesToNames);</span>
<span class="nc" id="L116">            trl.changed(filter);</span>
        }

<span class="nc" id="L119">        LOGGER.log(Level.INFO, &quot;Token revoked: &quot; + cti);</span>
<span class="nc" id="L120">        DhtLogger.sendLog(Const.TYPE_INFO, Const.PRIO_LOW, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                &quot;Token revoked. &quot;
                        + &quot;[ctiStr: &quot; + cti + &quot;. &quot;
                        + &quot;pertainingPeers: &quot; + peerIds + &quot;]&quot;);

        // +----------------------NOTES----------------------+
        // The UCS must have a reference to this component.
        // Indeed, the UCS should call this component when
        // a policy is not satisfied anymore.
        // When a policy is not satisfied anymore, the
        // UCS gets notified by the PEP, which specifies the
        // sessionId.
        // The UCS then retrieves the cti and invokes the
        // endAccess method for all the sessions associated
        // with that cti.
        // At this point, the UCS calls the revoke method of
        // the RevocationHandler.
        // +-------------------------------------------------+

<span class="nc" id="L139">    }</span>

    private void addRevokedTokenHashToDiffSets(String cti, Set&lt;String&gt; peerIds) throws AceException {
<span class="nc" id="L142">        String tokenHash = db.getTokenHashMap().get(cti);</span>

<span class="nc" id="L144">        CBORObject added = CBORObject.NewArray();</span>
<span class="nc" id="L145">        added.Add(CBORObject.FromObject(tokenHash.getBytes(Constants.charset)));</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">        for (String id : peerIds) {</span>
            try {
<span class="nc" id="L149">                DiffSetsMap.get(id).pushDiffEntry(CBORObject.NewArray(), added);</span>
<span class="nc" id="L150">            } catch (AceException e) {</span>
<span class="nc" id="L151">                LOGGER.severe(&quot;Error adding a diff entry &quot; +</span>
<span class="nc" id="L152">                        &quot;to the DiffSet object: &quot; + e.getMessage());</span>
<span class="nc" id="L153">            }</span>
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">    }</span>


    private long getTimeToExpire(String cti) throws AceException {
<span class="nc" id="L159">        long exp = 0L;</span>
        try {
<span class="nc" id="L161">            exp = this.db.getExpirationTime(cti);</span>
<span class="nc" id="L162">        } catch(AceException e) {</span>
<span class="nc" id="L163">            LOGGER.severe(&quot;Error getting token expiration time&quot;</span>
<span class="nc" id="L164">                    + e.getMessage());</span>
<span class="nc" id="L165">            throw new AceException(e.getMessage());</span>
<span class="nc" id="L166">        }</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (exp == 0L) { // expiration time not found in the db</span>
<span class="nc" id="L168">            LOGGER.log(Level.INFO, &quot;Expiration time not found for token: &quot;, cti);</span>
<span class="nc" id="L169">            throw new AceException(&quot;Expiration time not found for token&quot;);</span>
        }
<span class="nc" id="L171">        long now = this.time.getCurrentTime();</span>

<span class="nc" id="L173">        long delay = exp - now;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (delay &lt; 0) {</span>
            // Trying to revoke an already expired token
            // This might happen since /token and /introspect
            // purge expired tokens in a lazy fashion.
<span class="nc" id="L178">            LOGGER.log(Level.INFO, &quot;The token to be revoked is already expired&quot;);</span>

            // However, since at least one expired token exists,
            // we purge expired tokens from the database
            try {
<span class="nc" id="L183">                Set&lt;String&gt; ctis = db.getExpiredTokens(now);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                if (this.pdp instanceof UcsHelper) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    for (String i : ctis)</span>
<span class="nc" id="L186">                        this.pdp.removeSessions4Cti(i);</span>
                }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                for (String i : ctis) {</span>
<span class="nc" id="L189">                    this.db.deleteTokenHash(i);</span>
<span class="nc" id="L190">                }</span>
<span class="nc" id="L191">                this.db.purgeExpiredTokens(now);</span>
<span class="nc" id="L192">            } catch (AceException e) {</span>
<span class="nc" id="L193">                LOGGER.severe(&quot;Database error: &quot; + e.getMessage());</span>
<span class="nc" id="L194">                throw new AceException(e.getMessage());</span>
<span class="nc" id="L195">            }</span>
<span class="nc" id="L196">            LOGGER.log(Level.INFO, &quot;Expired tokens purged from the database&quot;);</span>
        }
<span class="nc" id="L198">        return delay;</span>
    }


    public class ExpirationTask extends TimerTask {

        private final String cti;

<span class="nc" id="L206">        public ExpirationTask(String cti) {</span>
<span class="nc" id="L207">            this.cti = cti;</span>
<span class="nc" id="L208">        }</span>

        /**
         * Trigger when a revoked token expires.
         * It performs the following operations:
         * - Get the pertaining peers
         * - Update pertaining peers' DiffSets structures
         * - Remove the expired token from trlTable and from tokenHashTable
         * - Notify observing pertaining peers
         */
        @Override
        public void run() {

<span class="nc" id="L221">            LOGGER.info(&quot;Revoked token expired. &quot; +</span>
                    &quot;Trying to remove it from the trl and notify the peers (if enabled)...&quot; );

            //1. Get the pertaining peers
<span class="nc" id="L225">            Set&lt;String&gt; peerIds = new HashSet&lt;&gt;();</span>

            try {
<span class="nc" id="L228">                peerIds = db.getPertainingPeers(cti);</span>
<span class="nc" id="L229">            } catch (AceException e) {</span>
<span class="nc" id="L230">                LOGGER.severe(&quot;Token removal from trl aborted: &quot;</span>
                        + &quot;(getting peers identities from db) &quot;
<span class="nc" id="L232">                        + e.getMessage());</span>
<span class="nc" id="L233">                DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                        &quot;Token removal from trl aborted: (getting peers identities from db)&quot;);
<span class="nc" id="L235">                return;</span>
<span class="nc" id="L236">            }</span>


            //2. Update pertaining peers' DiffSets structures
<span class="nc" id="L240">            String tokenHash = null;</span>
            try {
<span class="nc" id="L242">                tokenHash = db.getTokenHashMap().get(cti);</span>
<span class="nc" id="L243">            } catch (AceException e) {</span>
<span class="nc" id="L244">                LOGGER.severe(&quot;Token removal from trl aborted:&quot; +</span>
                        &quot;(getting token hash from db) &quot;
<span class="nc" id="L246">                        + e.getMessage());</span>
<span class="nc" id="L247">                DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                        &quot;Token removal from trl aborted: (getting token hash from db)&quot;);
<span class="nc" id="L249">                return;</span>
<span class="nc" id="L250">            }</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (tokenHash == null) {</span>
<span class="nc" id="L252">                LOGGER.severe(&quot;Error deleting token: Token hash not found.&quot;);</span>
<span class="nc" id="L253">                return;</span>
            }
<span class="nc" id="L255">            CBORObject removed = CBORObject.NewArray();</span>
<span class="nc" id="L256">            removed.Add(CBORObject.FromObject(tokenHash.getBytes(Constants.charset)));</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">            for (String id : peerIds) {</span>
                try {
<span class="nc" id="L260">                    DiffSetsMap.get(id).pushDiffEntry(removed, CBORObject.NewArray());</span>
<span class="nc" id="L261">                } catch (AceException e) {</span>
<span class="nc" id="L262">                    LOGGER.severe(&quot;Error adding a diff entry &quot; +</span>
<span class="nc" id="L263">                            &quot;to the DiffSet object: &quot; + e.getMessage());</span>
<span class="nc" id="L264">                    DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                            &quot;Error adding a diff entry to the DiffSet object&quot;);
<span class="nc" id="L266">                }</span>
<span class="nc" id="L267">            }</span>


            //3. Remove the expired token from trlTable and from tokenHashTable
            try {
<span class="nc" id="L272">                db.deleteExpiredToken(cti);</span>
<span class="nc" id="L273">                db.deleteTokenHash(cti);</span>
<span class="nc" id="L274">            } catch (AceException e) {</span>
<span class="nc" id="L275">                LOGGER.severe(&quot;Error deleting expired token: &quot;</span>
<span class="nc" id="L276">                        + e.getMessage());</span>
<span class="nc" id="L277">                DhtLogger.sendLog(Const.TYPE_ERROR, Const.PRIO_HIGH, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                        &quot;Token removal from trl aborted: (deleting token hash from db)&quot;);
<span class="nc" id="L279">                return;</span>
<span class="nc" id="L280">            }</span>


            //4. Notify observing pertaining peers
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (trl != null) {</span>
<span class="nc" id="L285">                PertainingPeersFilter filter = new PertainingPeersFilter(peerIds, peerIdentitiesToNames);</span>
<span class="nc" id="L286">                trl.changed(filter); // notify observers</span>
            }

<span class="nc" id="L289">            LOGGER.info(&quot;Token removal from the trl completed: &quot; + cti);</span>
<span class="nc" id="L290">            DhtLogger.sendLog(Const.TYPE_INFO, Const.PRIO_LOW, Const.CAT_STATUS, Const.DEVICE_NAME,</span>
                    &quot;Token removal from the trl completed. &quot;
                            + &quot;[ctiStr: &quot; + cti + &quot;. &quot;
                            + &quot;pertainingPeers: &quot; + peerIds + &quot;]&quot;);
<span class="nc" id="L294">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>